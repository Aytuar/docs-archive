# Change the hostname of a monolithic master in Puppet Enterprise 2016.5
<p>I am changing the hostname of my master. How do I make the corresponding updates to PE?</p>
<h3 id="version-and-installation-information">Version and installation information</h3>
<p><strong>PE version:</strong> 2016.5<br><strong>OS:</strong> CentOS 6.6/7<br><strong>Installation type:</strong> Monolithic</p>
<h3 id="solution">Solution</h3>
<p><strong>Note:</strong> The following files on the master will be updated during this process, back them up before beginning the process:</p>
<pre>/etc/puppetlabs/puppet/puppet.conf
/etc/puppetlabs/console-services/conf.d/activity-database.conf 
/etc/puppetlabs/console-services/conf.d/rbac-database.conf
/etc/puppetlabs/console-services/conf.d/classifier-database.conf
/etc/puppetlabs/code/environments/production/manifests/site.pp</pre>
<p>To change the hostname of a monolithic master:</p>
<ol style="list-style-type: decimal;">
<li>
<p>Log into the master as root.</p>
</li>
<li>
<p>Back up the <code>/etc/puppetlabs/puppet/ssl/</code> directory by running <code>cp -r /etc/puppetlabs/puppet/ssl/ /etc/puppetlabs/puppet/ssl_bak/</code>.</p>
<p><strong>Note:</strong> If something goes wrong, you can restore these directories to keep your deployment functioning.</p>
</li>
<li>
<p>Stop the Puppet agent daemon on the master by running <code>puppet resource service puppet ensure=stopped</code>.</p>
</li>
<li>
<p>Log into the console.</p>
</li>
<li>
<p>Navigate to the PE Infrastructure classifier group by clicking <strong>Nodes</strong> and then <strong>Classification</strong>. Select the <strong>PE Infrastructure</strong> node group, and then select the <strong>Classes</strong> tab.</p>
</li>
<li>
<p>Update all instances of the hostname in the PE Infrastructure classifier group by clicking <strong>Edit</strong> beside each instance of your old hostname and changing the <strong>Value</strong> to your new hostname. Click <strong>Commit changes</strong>.</p>
<p><strong>Note:</strong> By default there are seven instances to change in a 2016.5 monolithic installation: <code>mcollective_middleware_hosts</code>, <code>database_host</code>, <code>puppetdb_host</code>, <code>puppet_master_host</code>, <code>certificate_authority_host</code>, and <code>console_host, pcp_broker_host</code>.</p>
</li>
<li>
<p>Log into the master as root.</p>
</li>
<li>
<p>Update all instances of the master hostname in <code>/etc/puppetlabs/puppet/puppet.conf</code> by running <code>sed -i "s/&lt;OLD HOSTNAME&gt;/&lt;NEW HOSTNAME&gt;/g" /etc/puppetlabs/puppet/puppet.conf</code>.</p>
</li>
<li>Restart Puppet Server to regenerate the certificate for the new hostname by running:
<ul>
<li><code>puppet resource service pe-puppetserver ensure=stopped</code></li>
<li><code>puppet resource service pe-puppetserver ensure=running<br><br></code></li>
</ul>
</li>
<li>Verify that the certificate has been regenerated by running <code>puppet cert list --all</code>. The new certificate will be in the list of certificates returned.</li>
<li>Create a <code>change_monolithic_master_name.pp</code> manifest file in any convenient location on the master, with the following content, replacing with your new hostname.
<pre># change_monolithic_master_name.pp

# NOTE: This intentionally causes a syntax error unless filled in with a string:
$new_master_name = ''

class {'puppet_enterprise':
  mcollective_middleware_hosts =&gt; [$new_master_name],
  database_host =&gt; $new_master_name,
  puppetdb_host =&gt; $new_master_name,
  database_port =&gt; 5432,
  database_ssl =&gt; true,
  puppet_master_host =&gt; $new_master_name,
  certificate_authority_host =&gt; $new_master_name,
  console_port =&gt; '443',
  puppetdb_database_name =&gt; 'pe-puppetdb',
  puppetdb_database_user =&gt; 'pe-puppetdb',
  puppetdb_port =&gt; '8081',
  console_host =&gt; $new_master_name,
}

include puppet_enterprise::profile::mcollective::agent

include puppet_enterprise::profile::certificate_authority

include puppet_enterprise::profile::amq::broker

include puppet_enterprise::profile::master
include puppet_enterprise::profile::mcollective::peadmin
include puppet_enterprise::profile::master::mcollective

include puppet_enterprise::profile::puppetdb
include puppet_enterprise::profile::database

include puppet_enterprise::profile::console
include puppet_enterprise::license
class {'pe_console_prune': prune_upto =&gt; 30}
</pre>
</li>
<li>Apply the manifest by running <code>puppet apply change_monolithic_master_name.pp</code>.
<p><strong>Note:</strong> When the file is applied successfully, there are exported resource warnings which you can ignore.</p>
</li>
<li>
<p>Update references to your hostname in the following files:<br><code>/etc/puppetlabs/console-services/conf.d/activity-database.conf</code><br><code>/etc/puppetlabs/console-services/conf.d/rbac-database.conf</code><br><code>/etc/puppetlabs/console-services/conf.d/classifier-database.conf</code></p>
<p>by running <code>sed -i "s/&lt;OLD HOSTNAME&gt;/&lt;NEW HOSTNAME&gt;/g" /etc/puppetlabs/console-services/conf.d/*</code>.</p>
</li>
<li>Update references to your hostname in <code>/etc/puppetlabs/code/environments/production/manifests/site.pp</code> by running <code>sed -i "s/&lt;OLD HOSTNAME&gt;/&lt;NEW HOSTNAME&gt;/g" /etc/puppetlabs/code/environments/production/manifests/site.pp</code>.</li>
<li>Propagate DNS changes and updates to the master hostname in your enterprise network.</li>
<li>Restart PE console services by running:<br>
<ul>
<li><code>puppet resource service pe-console-services ensure=stopped</code></li>
<li><code>puppet resource service pe-console-services ensure=running<br><br></code></li>
</ul>
</li>
<li>Restart PuppetDB by running:
<ul>
<li><code>puppet resource service pe-puppetdb ensure=stopped</code></li>
<li><code>puppet resource service pe-puppetdb ensure=running<br><br></code></li>
</ul>
</li>
<li>Verify that the infrastructure is working by running <code>puppet agent -t --noop</code>.</li>
<li>Start the puppet service by running <code>puppet resource service puppet ensure=running</code>.</li>
<li>Enable communication between the master and agents by updating all instances of your hostname in your agents' <code>/etc/puppetlabs/puppet/puppet.conf</code> files.</li>
<li>Revoke the certificate and remove all files related to the old hostname by running <code>puppet cert clean &lt;OLD HOSTNAME&gt;</code>.</li>
</ol>
